"use strict";(()=>{var e={};e.id=4594,e.ids=[4594],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},35816:e=>{e.exports=require("process")},6162:e=>{e.exports=require("worker_threads")},72254:e=>{e.exports=require("node:buffer")},6005:e=>{e.exports=require("node:crypto")},87561:e=>{e.exports=require("node:fs")},88849:e=>{e.exports=require("node:http")},22286:e=>{e.exports=require("node:https")},87503:e=>{e.exports=require("node:net")},49411:e=>{e.exports=require("node:path")},97742:e=>{e.exports=require("node:process")},84492:e=>{e.exports=require("node:stream")},72477:e=>{e.exports=require("node:stream/web")},41041:e=>{e.exports=require("node:url")},47261:e=>{e.exports=require("node:util")},65628:e=>{e.exports=require("node:zlib")},2156:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>U,patchFetch:()=>b,requestAsyncStorage:()=>A,routeModule:()=>D,serverHooks:()=>R,staticGenerationAsyncStorage:()=>v});var s={};r.r(s),r.d(s,{GET:()=>P,OPTIONS:()=>T,POST:()=>N});var o=r(49303),n=r(88716),a=r(60670),i=r(87070),l=r(12497),c=r(53524),u=r(43895),d=r(92048),p=r.n(d),m=r(55315),g=r.n(m);let f=new c.PrismaClient({log:["query","info","warn","error"]}),h={};function x(){try{let e=g().join(process.cwd(),"temp-tickets.json");p().writeFileSync(e,JSON.stringify(h),"utf8"),u.ZP.debug(`Tickets temporaires sauvegard\xe9s dans ${e}`)}catch(e){u.ZP.error("Erreur lors de la sauvegarde des tickets temporaires:",e)}}!function(){try{let e=g().join(process.cwd(),"temp-tickets.json");if(p().existsSync(e)){let t=p().readFileSync(e,"utf8"),r=JSON.parse(t);Object.keys(r).forEach(e=>{r[e]=r[e].map(e=>({...e,createdAt:new Date(e.createdAt),updatedAt:new Date(e.updatedAt)}))}),Object.assign(h,r),u.ZP.debug(`Tickets temporaires charg\xe9s depuis ${e}`)}}catch(e){u.ZP.error("Erreur lors du chargement des tickets temporaires:",e)}}();let y=0;Date.now();let w={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, PUT, DELETE, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization","Access-Control-Max-Age":"86400"};async function P(e){y++,console.log(`GET /api/tickets - Requ\xeate #${y} - D\xe9but`);try{let t;let r=new URL(e.url);if("true"===r.searchParams.get("demo")){console.log("Mode d\xe9mo activ\xe9, cr\xe9ation de tickets de d\xe9monstration");let e=[{id:`demo-${Date.now()}-${Math.random().toString(36).substring(2,15)}`,title:"Probl\xe8me de connexion",description:"Je n'arrive pas \xe0 me connecter \xe0 mon compte.",priority:"high",status:"open",category:"support",userId:"demo",createdAt:new Date,updatedAt:new Date,clientName:"Client D\xe9mo",user:{id:"demo",email:"demo@example.com",firstName:"Utilisateur",lastName:"D\xe9mo"},messages:[]},{id:`demo-${Date.now()}-${Math.random().toString(36).substring(2,15)}`,title:"Question sur la facturation",description:"Je souhaiterais des informations sur ma derni\xe8re facture.",priority:"medium",status:"in_progress",category:"billing",userId:"demo",createdAt:new Date(Date.now()-864e5),updatedAt:new Date(Date.now()-432e5),clientName:"Client D\xe9mo",user:{id:"demo",email:"demo@example.com",firstName:"Utilisateur",lastName:"D\xe9mo"},messages:[]}];return console.log(`${e.length} tickets de d\xe9monstration cr\xe9\xe9s`),i.NextResponse.json(e,{headers:{"Cache-Control":"no-store","X-Demo-Data":"true"}})}let s=!1;try{let e=await (0,l.I)();t=e.userId;let r=e.sessionClaims?.metadata||{};Array.isArray(r.roles)&&r.roles.includes("admin")&&(s=!0,console.log("Utilisateur authentifi\xe9 avec r\xf4le admin via Clerk"))}catch(e){return console.error("Erreur d'authentification:",e),i.NextResponse.json({error:"Non authentifi\xe9"},{status:401})}if(!t)return i.NextResponse.json({error:"Non authentifi\xe9"},{status:401,headers:{"Cache-Control":"no-store",Pragma:"no-cache"}});if(!s)try{let e=await f.user.findUnique({where:{id:t},select:{role:!0}});(s=e?.role==="admin")&&console.log("Utilisateur identifi\xe9 comme admin via la base de donn\xe9es")}catch(e){console.error("Erreur lors de la v\xe9rification du r\xf4le dans la base de donn\xe9es:",e),s=!1}let o=s?{}:{userId:t};console.log(`R\xe9cup\xe9ration des tickets avec whereClause: ${JSON.stringify(o)}`);try{console.log("Tentative de r\xe9cup\xe9ration des tickets depuis la base de donn\xe9es...");let e=await f.ticket.findMany({where:o,orderBy:{createdAt:"desc"},include:{user:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},messages:{orderBy:{createdAt:"asc"},include:{user:{select:{id:!0,email:!0,firstName:!0,lastName:!0}}}}}});if(console.log(`Tickets r\xe9cup\xe9r\xe9s: ${e.length}`),0===e.length)return console.log("Aucun ticket trouv\xe9, retour d'un tableau vide"),i.NextResponse.json([],{headers:{"Cache-Control":"no-store"}});return e.sort((e,t)=>{let r=e.createdAt instanceof Date?e.createdAt.getTime():new Date(e.createdAt).getTime();return(t.createdAt instanceof Date?t.createdAt.getTime():new Date(t.createdAt).getTime())-r}),console.log(`${e.length} tickets trouv\xe9s pour ${s?"admin":t}`),i.NextResponse.json(e,{headers:{"Cache-Control":"no-store"}})}catch(e){return console.error("Erreur lors de la r\xe9cup\xe9ration des tickets depuis la base de donn\xe9es:",e),console.log("Retour d'un tableau vide en raison d'une erreur de base de donn\xe9es"),i.NextResponse.json([],{headers:{"Cache-Control":"no-store","X-Error":"database_error"}})}}catch(e){return console.error("Erreur globale lors de la r\xe9cup\xe9ration des tickets:",e),i.NextResponse.json([],{headers:{"Cache-Control":"no-store","X-Error":"global_error"}})}}async function N(e){u.ZP.info("POST /api/tickets - D\xe9but de la cr\xe9ation de ticket");try{let t=await e.json();if(console.log("API /tickets - Donn\xe9es re\xe7ues:",t),!t.title||!t.description)return i.NextResponse.json({error:"Le titre et la description sont obligatoires"},{status:400});t.category||(t.category="other"),["low","medium","high","urgent"].includes(t.priority)||(t.priority="medium");try{let e;try{e=(await (0,l.I)()).userId}catch(e){return console.error("API /tickets - Erreur d'authentification:",e),i.NextResponse.json({error:"Non authentifi\xe9"},{status:401})}if(!e)return i.NextResponse.json({error:"Non authentifi\xe9"},{status:401});try{let r=await f.ticket.create({data:{title:t.title,description:t.description,status:"open",priority:t.priority,category:t.category,userId:e,ftpHost:t.ftpHost||null,ftpPort:t.ftpPort||null,ftpUsername:t.ftpUsername||null,ftpPassword:t.ftpPassword||null,cmsType:t.cmsType||null,cmsUrl:t.cmsUrl||null,cmsUsername:t.cmsUsername||null,cmsPassword:t.cmsPassword||null,hostingProvider:t.hostingProvider||null,hostingPlan:t.hostingPlan||null}});Date.now();let s={id:`temp-${Date.now()}-${Math.random().toString(36).substring(2,15)}`,title:t.title,description:t.description,priority:t.priority||"medium",status:"open",category:t.category||"support",userId:e,createdAt:new Date,updatedAt:new Date,clientId:null,clientName:"Client Temporaire",assignedToId:null,ftpHost:t.ftpHost||null,ftpPort:t.ftpPort||null,ftpUsername:t.ftpUsername||null,ftpPassword:t.ftpPassword||null,cmsType:t.cmsType||null,cmsUrl:t.cmsUrl||null,cmsUsername:t.cmsUsername||null,cmsPassword:t.cmsPassword||null,hostingProvider:t.hostingProvider||null,hostingPlan:t.hostingPlan||null,user:{id:e,email:"utilisateur@temporaire.com",firstName:"Utilisateur",lastName:"Temporaire",role:"client"},messages:[]};return h[e]||(h[e]=[]),h[e].push(s),x(),i.NextResponse.json(r,{status:201})}catch(s){u.ZP.error("Erreur lors de la cr\xe9ation du ticket dans la base de donn\xe9es:",s);let r={id:`demo-${Date.now()}-${Math.random().toString(36).substring(2,15)}`,title:t.title||"Ticket de d\xe9monstration",description:t.description||"Ceci est un ticket de d\xe9monstration cr\xe9\xe9 automatiquement.",priority:t.priority||"medium",status:"open",category:t.category||"support",userId:e,createdAt:new Date,updatedAt:new Date,clientId:null,clientName:"Client D\xe9mo",assignedToId:null,ftpHost:t.ftpHost||null,ftpPort:t.ftpPort||null,ftpUsername:t.ftpUsername||null,ftpPassword:t.ftpPassword||null,cmsType:t.cmsType||null,cmsUrl:t.cmsUrl||null,cmsUsername:t.cmsUsername||null,cmsPassword:t.cmsPassword||null,hostingProvider:t.hostingProvider||null,hostingPlan:t.hostingPlan||null,user:{id:e,email:"demo@example.com",firstName:"Utilisateur",lastName:"D\xe9mo",role:"client"},messages:[]};return h[e]||(h[e]=[]),h[e].push(r),x(),i.NextResponse.json(r,{status:201,headers:{"X-Demo-Ticket":"true","X-Error":"database_error"}})}}catch(r){u.ZP.error("Erreur lors de la cr\xe9ation du ticket:",r);let e={id:`demo-${Date.now()}-${Math.random().toString(36).substring(2,15)}`,title:t.title||"Ticket de d\xe9monstration",description:t.description||"Ceci est un ticket de d\xe9monstration cr\xe9\xe9 automatiquement.",priority:t.priority||"medium",status:"open",category:t.category||"support",userId:"demo-user",createdAt:new Date,updatedAt:new Date,clientId:null,clientName:"Client D\xe9mo",assignedToId:null,ftpHost:t.ftpHost||null,ftpPort:t.ftpPort||null,ftpUsername:t.ftpUsername||null,ftpPassword:t.ftpPassword||null,cmsType:t.cmsType||null,cmsUrl:t.cmsUrl||null,cmsUsername:t.cmsUsername||null,cmsPassword:t.cmsPassword||null,hostingProvider:t.hostingProvider||null,hostingPlan:t.hostingPlan||null,user:{id:"demo",email:"demo@example.com",firstName:"Utilisateur",lastName:"D\xe9mo",role:"client"},messages:[]};return h["demo-user"]||(h["demo-user"]=[]),h["demo-user"].push(e),x(),i.NextResponse.json(e,{status:201})}}catch(e){return u.ZP.error("Erreur serveur lors de la cr\xe9ation du ticket:",e),i.NextResponse.json({error:"Erreur serveur"},{status:500})}}async function k(){console.log("Suppression de tous les tickets et donn\xe9es associ\xe9es...");try{return await f.$transaction(async e=>{await e.messageReaction.deleteMany({}),console.log("Toutes les r\xe9actions aux messages ont \xe9t\xe9 supprim\xe9es"),await e.attachment.deleteMany({}),console.log("Toutes les pi\xe8ces jointes ont \xe9t\xe9 supprim\xe9es"),await e.message.deleteMany({}),console.log("Tous les messages ont \xe9t\xe9 supprim\xe9s"),await e.ticket.deleteMany({}),console.log("Tous les tickets ont \xe9t\xe9 supprim\xe9s")}),console.log("Nettoyage complet termin\xe9 avec succ\xe8s"),!0}catch(e){return console.error("Erreur lors de la suppression de tous les tickets:",e),!1}}async function T(e){console.log("OPTIONS request received to delete all tickets");try{console.log("Authentication disabled for OPTIONS request in development");try{if(await k())return console.log("All tickets deleted successfully"),i.NextResponse.json({message:"Tous les tickets ont \xe9t\xe9 supprim\xe9s avec succ\xe8s"},{status:200,headers:w});return console.error("Error deleting tickets"),i.NextResponse.json({message:"Erreur lors de la suppression des tickets"},{status:500,headers:w})}catch(e){return console.error("Error deleting tickets:",e),i.NextResponse.json({message:"Erreur lors de la suppression des tickets"},{status:500,headers:w})}}catch(e){return console.error("Server error:",e),i.NextResponse.json({message:"Erreur serveur"},{status:500,headers:w})}}let D=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/tickets/route",pathname:"/api/tickets",filename:"route",bundlePath:"app/api/tickets/route"},resolvedPagePath:"C:\\Users\\audif\\Desktop\\appshade\\src\\app\\api\\tickets\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:A,staticGenerationAsyncStorage:v,serverHooks:R}=D,U="/api/tickets/route";function b(){return(0,a.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:v})}},49303:(e,t,r)=>{e.exports=r(30517)},43895:(e,t,r)=>{var s;r.d(t,{ZP:()=>c}),function(e){e[e.DEBUG=0]="DEBUG",e[e.INFO=1]="INFO",e[e.WARN=2]="WARN",e[e.ERROR=3]="ERROR",e[e.NONE=4]="NONE"}(s||(s={}));let o=3,n={},a=(e,t)=>`[${e}] ${t}`,i=e=>{let t=Date.now();if(!n[e])return n[e]={count:1,lastTime:t},!1;let r=n[e];return t-r.lastTime>1e4?(n[e]={count:1,lastTime:t},!1):(r.count++,10===r.count)?(r.lastTime=t,!1):1!==r.count},l={setLogLevel:e=>{o=e},getLogLevel:()=>o,debug:(e,...t)=>{if(o<=0){let r=`DEBUG:${e}`;if(!i(r)){let s=n[r];console.debug(a("DEBUG",e+(s&&s.count>1?` (r\xe9p\xe9t\xe9 ${s.count} fois)`:"")),...t)}}},info:(e,...t)=>{if(o<=1){let r=`INFO:${e}`;if(!i(r)){let s=n[r];console.info(a("INFO",e+(s&&s.count>1?` (r\xe9p\xe9t\xe9 ${s.count} fois)`:"")),...t)}}},warn:(e,...t)=>{if(o<=2){let r=`WARN:${e}`;if(!i(r)){let s=n[r];console.warn(a("WARN",e+(s&&s.count>1?` (r\xe9p\xe9t\xe9 ${s.count} fois)`:"")),...t)}}},error:(e,...t)=>{if(o<=3){let r=`ERROR:${e}`;if(!i(r)){let s=n[r];console.error(a("ERROR",e+(s&&s.count>1?` (r\xe9p\xe9t\xe9 ${s.count} fois)`:"")),...t)}}},once:(e,t,...r)=>{let s=`ONCE:${t}`;if(!n[s])switch(n[s]={count:1,lastTime:Date.now()},e){case 0:l.debug(t,...r);break;case 1:l.info(t,...r);break;case 2:l.warn(t,...r);break;case 3:l.error(t,...r)}}},c=l}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[2510,4140,2497],()=>r(2156));module.exports=s})();