"use strict";(()=>{var e={};e.id=7313,e.ids=[7313],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},35816:e=>{e.exports=require("process")},6162:e=>{e.exports=require("worker_threads")},72254:e=>{e.exports=require("node:buffer")},6005:e=>{e.exports=require("node:crypto")},87561:e=>{e.exports=require("node:fs")},88849:e=>{e.exports=require("node:http")},22286:e=>{e.exports=require("node:https")},87503:e=>{e.exports=require("node:net")},49411:e=>{e.exports=require("node:path")},97742:e=>{e.exports=require("node:process")},84492:e=>{e.exports=require("node:stream")},72477:e=>{e.exports=require("node:stream/web")},41041:e=>{e.exports=require("node:url")},47261:e=>{e.exports=require("node:util")},65628:e=>{e.exports=require("node:zlib")},89247:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>$,patchFetch:()=>D,requestAsyncStorage:()=>v,routeModule:()=>U,serverHooks:()=>I,staticGenerationAsyncStorage:()=>k});var n={};r.r(n),r.d(n,{DELETE:()=>b,GET:()=>y,POST:()=>E});var s=r(49303),o=r(88716),i=r(60670),a=r(87070),u=r(12497),c=r(53524),p=r(84770);let l={randomUUID:p.randomUUID},d=new Uint8Array(256),x=d.length,f=[];for(let e=0;e<256;++e)f.push((e+256).toString(16).slice(1));let h=function(e,t,r){if(l.randomUUID&&!t&&!e)return l.randomUUID();let n=(e=e||{}).random??e.rng?.()??(x>d.length-16&&((0,p.randomFillSync)(d),x=0),d.slice(x,x+=16));if(n.length<16)throw Error("Random bytes length must be >= 16");if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,t){if((r=r||0)<0||r+16>t.length)throw RangeError(`UUID byte range ${r}:${r+15} is out of buffer bounds`);for(let e=0;e<16;++e)t[r+e]=n[e];return t}return function(e,t=0){return(f[e[t+0]]+f[e[t+1]]+f[e[t+2]]+f[e[t+3]]+"-"+f[e[t+4]]+f[e[t+5]]+"-"+f[e[t+6]]+f[e[t+7]]+"-"+f[e[t+8]]+f[e[t+9]]+"-"+f[e[t+10]]+f[e[t+11]]+f[e[t+12]]+f[e[t+13]]+f[e[t+14]]+f[e[t+15]]).toLowerCase()}(n)};var m=r(55315),w=r.n(m),R=r(92048),q=r.n(R),N=r(43895);let j=new c.PrismaClient({log:["error"]}),g=w().join(process.cwd(),"public","uploads");async function y(e,{params:t}){try{let{userId:e}=await (0,u.I)();if(!e)return a.NextResponse.json({error:"Non autoris\xe9"},{status:401});let{id:r}=t,n=await j.attachment.findMany({where:{ticketId:r},orderBy:{createdAt:"desc"}});return a.NextResponse.json({attachments:n})}catch(e){return N.ZP.error("Erreur lors de la r\xe9cup\xe9ration des pi\xe8ces jointes:",e),a.NextResponse.json({error:"Erreur serveur"},{status:500})}}async function E(e,{params:t}){try{let{userId:r}=await (0,u.I)();if(!r)return a.NextResponse.json({error:"Non autoris\xe9"},{status:401});let{id:n}=t,{fileName:s,fileType:o,fileSize:i,fileData:c}=await e.json();if(!s||!o||!c)return a.NextResponse.json({error:"Donn\xe9es invalides"},{status:400});let p=await j.ticket.findUnique({where:{id:n}});if(!p)return a.NextResponse.json({error:"Ticket non trouv\xe9"},{status:404});if(p.userId!==r){let e=await j.user.findUnique({where:{id:r},select:{role:!0}});if(e?.role!=="admin")return a.NextResponse.json({error:"Non autoris\xe9"},{status:403})}let l=s.split(".").pop(),d=`${h()}.${l}`,x=w().join(g,d),f=`/uploads/${d}`,m=c.split(";base64,").pop();q().writeFileSync(x,m,{encoding:"base64"});let R=await j.attachment.create({data:{fileName:s,fileType:o,fileSize:i,filePath:f,ticketId:n,userId:r}});return a.NextResponse.json({attachment:R,fileUrl:f})}catch(e){return N.ZP.error("Erreur lors de l'ajout d'une pi\xe8ce jointe:",e),a.NextResponse.json({error:"Erreur serveur"},{status:500})}}async function b(e,{params:t}){try{let{userId:r}=await (0,u.I)();if(!r)return a.NextResponse.json({error:"Non autoris\xe9"},{status:401});let{id:n}=t,{attachmentId:s}=await e.json();if(!s)return a.NextResponse.json({error:"ID de pi\xe8ce jointe manquant"},{status:400});let o=await j.attachment.findUnique({where:{id:s},include:{ticket:!0}});if(!o)return a.NextResponse.json({error:"Pi\xe8ce jointe non trouv\xe9e"},{status:404});if(o.userId!==r&&o.ticket.userId!==r){let e=await j.user.findUnique({where:{id:r},select:{role:!0}});if(e?.role!=="admin")return a.NextResponse.json({error:"Non autoris\xe9"},{status:403})}let i=w().join(process.cwd(),"public",o.filePath);return q().existsSync(i)&&q().unlinkSync(i),await j.attachment.delete({where:{id:s}}),a.NextResponse.json({success:!0})}catch(e){return N.ZP.error("Erreur lors de la suppression d'une pi\xe8ce jointe:",e),a.NextResponse.json({error:"Erreur serveur"},{status:500})}}q().existsSync(g)||q().mkdirSync(g,{recursive:!0});let U=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/tickets/[id]/attachments/route",pathname:"/api/tickets/[id]/attachments",filename:"route",bundlePath:"app/api/tickets/[id]/attachments/route"},resolvedPagePath:"C:\\Users\\audif\\Desktop\\appshade\\src\\app\\api\\tickets\\[id]\\attachments\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:v,staticGenerationAsyncStorage:k,serverHooks:I}=U,$="/api/tickets/[id]/attachments/route";function D(){return(0,i.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:k})}},49303:(e,t,r)=>{e.exports=r(30517)},43895:(e,t,r)=>{var n;r.d(t,{ZP:()=>c}),function(e){e[e.DEBUG=0]="DEBUG",e[e.INFO=1]="INFO",e[e.WARN=2]="WARN",e[e.ERROR=3]="ERROR",e[e.NONE=4]="NONE"}(n||(n={}));let s=3,o={},i=(e,t)=>`[${e}] ${t}`,a=e=>{let t=Date.now();if(!o[e])return o[e]={count:1,lastTime:t},!1;let r=o[e];return t-r.lastTime>1e4?(o[e]={count:1,lastTime:t},!1):(r.count++,10===r.count)?(r.lastTime=t,!1):1!==r.count},u={setLogLevel:e=>{s=e},getLogLevel:()=>s,debug:(e,...t)=>{if(s<=0){let r=`DEBUG:${e}`;if(!a(r)){let n=o[r];console.debug(i("DEBUG",e+(n&&n.count>1?` (r\xe9p\xe9t\xe9 ${n.count} fois)`:"")),...t)}}},info:(e,...t)=>{if(s<=1){let r=`INFO:${e}`;if(!a(r)){let n=o[r];console.info(i("INFO",e+(n&&n.count>1?` (r\xe9p\xe9t\xe9 ${n.count} fois)`:"")),...t)}}},warn:(e,...t)=>{if(s<=2){let r=`WARN:${e}`;if(!a(r)){let n=o[r];console.warn(i("WARN",e+(n&&n.count>1?` (r\xe9p\xe9t\xe9 ${n.count} fois)`:"")),...t)}}},error:(e,...t)=>{if(s<=3){let r=`ERROR:${e}`;if(!a(r)){let n=o[r];console.error(i("ERROR",e+(n&&n.count>1?` (r\xe9p\xe9t\xe9 ${n.count} fois)`:"")),...t)}}},once:(e,t,...r)=>{let n=`ONCE:${t}`;if(!o[n])switch(o[n]={count:1,lastTime:Date.now()},e){case 0:u.debug(t,...r);break;case 1:u.info(t,...r);break;case 2:u.warn(t,...r);break;case 3:u.error(t,...r)}}},c=u}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[2510,4140,2497],()=>r(89247));module.exports=n})();