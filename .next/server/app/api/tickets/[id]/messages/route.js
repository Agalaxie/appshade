"use strict";(()=>{var e={};e.id=7682,e.ids=[7682],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},35816:e=>{e.exports=require("process")},6162:e=>{e.exports=require("worker_threads")},72254:e=>{e.exports=require("node:buffer")},6005:e=>{e.exports=require("node:crypto")},87561:e=>{e.exports=require("node:fs")},88849:e=>{e.exports=require("node:http")},22286:e=>{e.exports=require("node:https")},87503:e=>{e.exports=require("node:net")},49411:e=>{e.exports=require("node:path")},97742:e=>{e.exports=require("node:process")},84492:e=>{e.exports=require("node:stream")},72477:e=>{e.exports=require("node:stream/web")},41041:e=>{e.exports=require("node:url")},47261:e=>{e.exports=require("node:util")},65628:e=>{e.exports=require("node:zlib")},87650:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>j,patchFetch:()=>k,requestAsyncStorage:()=>w,routeModule:()=>N,serverHooks:()=>I,staticGenerationAsyncStorage:()=>q});var s={};r.r(s),r.d(s,{GET:()=>f,POST:()=>h});var o=r(49303),n=r(88716),i=r(60670),a=r(87070),u=r(12497),l=r(53524),d=r(92048),c=r.n(d),p=r(55315),m=r.n(p);let g=new l.PrismaClient({log:["error"]});function x(){try{let e=m().join(process.cwd(),"temp-tickets.json");if(c().existsSync(e)){let t=c().readFileSync(e,"utf8");return JSON.parse(t)}}catch(e){console.error("Erreur lors du chargement des tickets temporaires:",e)}return{}}async function f(e,{params:t}){try{let e;try{let{userId:t}=await (0,u.I)();if(!(e=t))return console.error("Utilisateur non authentifi\xe9"),a.NextResponse.json({error:"Non autoris\xe9"},{status:401})}catch(t){console.error("Erreur d'authentification:",t),e="demo-user",console.log("Utilisation de l'ID utilisateur de d\xe9mo pour GET messages:",e)}let r=t.id;if(r.startsWith("temp-")||r.startsWith("error-")||r.startsWith("demo-")){console.log("Ticket temporaire ou de d\xe9mo d\xe9tect\xe9 pour les messages:",r);let e=x(),t=null;if(Object.values(e).forEach(e=>{let s=e.find(e=>e.id===r);s&&(t=s)}),t&&t.messages&&t.messages.length>0)return console.log("Messages trouv\xe9s pour le ticket temporaire:",t.messages.length),a.NextResponse.json(t.messages);return a.NextResponse.json([{id:`demo-message-${Date.now()}-1`,content:"Bienvenue ! Comment puis-je vous aider avec ce ticket ?",createdAt:new Date(Date.now()-36e5).toISOString(),updatedAt:new Date(Date.now()-36e5).toISOString(),userId:"admin-user",ticketId:r,isInternal:!1,user:{id:"admin-user",firstName:"Support",lastName:"Technique",email:"support@appshade.com",role:"admin"}}])}let s=await g.ticket.findUnique({where:{id:r}});if(!s)return a.NextResponse.json({error:"Ticket non trouv\xe9"},{status:404});let o=!1,n=!1;try{let t=await g.user.findUnique({where:{id:e},select:{role:!0}});if(t&&"admin"===t.role&&(console.log("[INFO] Utilisateur identifi\xe9 comme admin via la base de donn\xe9es"),o=!0),n=s.userId===e,console.log(`[INFO] V\xe9rification des permissions pour l'utilisateur ${e} sur le ticket ${s.id}`),console.log(`[INFO] Propri\xe9taire: ${n}, Admin: ${o}`),!n&&!o)return console.log(`[INFO] Acc\xe8s refus\xe9: l'utilisateur n'est ni propri\xe9taire ni admin`),a.NextResponse.json({error:"Acc\xe8s non autoris\xe9 \xe0 ce ticket"},{status:403});console.log(`[INFO] Acc\xe8s autoris\xe9 pour l'utilisateur ${e}`)}catch(e){return console.error("Erreur lors de la v\xe9rification des permissions:",e),a.NextResponse.json({error:"Erreur lors de la v\xe9rification des permissions"},{status:500})}let i=await g.message.findMany({where:{ticketId:r,...o?{}:{isInternal:!1}},include:{user:{select:{id:!0,email:!0,firstName:!0,lastName:!0,role:!0}}},orderBy:{createdAt:"asc"}});return a.NextResponse.json(i)}catch(e){return console.error("Erreur lors de la r\xe9cup\xe9ration des messages:",e),a.NextResponse.json({error:"Erreur lors de la r\xe9cup\xe9ration des messages"},{status:500})}}async function h(e,{params:t}){try{let r;try{let{userId:e}=await (0,u.I)();if(!(r=e))return console.error("Utilisateur non authentifi\xe9"),a.NextResponse.json({error:"Non autoris\xe9"},{status:401})}catch(e){console.error("Erreur d'authentification:",e),r="demo-user",console.log("Utilisation de l'ID utilisateur de d\xe9mo pour POST message:",r)}let s=t.id,o=await e.json();if(!o.content)return a.NextResponse.json({error:"Le contenu du message est obligatoire"},{status:400});if(s.startsWith("temp-")||s.startsWith("error-")||s.startsWith("demo-")){console.log("Ticket temporaire ou de d\xe9mo d\xe9tect\xe9 pour ajouter un message:",s);let e=x(),t=null,n=null,i=-1;if(Object.entries(e).forEach(([e,r])=>{let o=r.findIndex(e=>e.id===s);-1!==o&&(t=r[o],n=e,i=o)}),t&&null!==n&&-1!==i){let u={id:`msg-${Date.now()}-${Math.random().toString(36).substring(2,15)}`,content:o.content,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),userId:r,ticketId:s,isInternal:o.isInternal||!1,user:{id:r,firstName:"demo-user"===r?"Utilisateur":"Client",lastName:"demo-user"===r?"D\xe9mo":"Temporaire",email:"demo-user"===r?"demo@example.com":"client@temporaire.com",role:"client"}};return t.messages||(t.messages=[]),t.messages.push(u),e[n][i]=t,function(e){try{let t=m().join(process.cwd(),"temp-tickets.json");c().writeFileSync(t,JSON.stringify(e),"utf8"),console.log(`Tickets temporaires sauvegard\xe9s dans ${t}`)}catch(e){console.error("Erreur lors de la sauvegarde des tickets temporaires:",e)}}(e),a.NextResponse.json(u,{status:201})}let u={id:`demo-message-${Date.now()}`,content:o.content,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),userId:r,ticketId:s,isInternal:o.isInternal||!1,user:{id:r,firstName:"Utilisateur",lastName:"D\xe9mo",email:"demo@example.com",role:"client"}};return a.NextResponse.json(u,{status:201,headers:{"X-Demo-Message":"true"}})}try{let e=await g.ticket.findUnique({where:{id:s}});if(!e)return a.NextResponse.json({error:"Ticket non trouv\xe9"},{status:404});if(e.userId!==r){let e=await g.user.findUnique({where:{id:r},select:{role:!0}});if(e?.role!=="admin")return a.NextResponse.json({error:"Non autoris\xe9"},{status:403})}let t=await g.message.create({data:{content:o.content,userId:r,ticketId:s},include:{user:{select:{id:!0,firstName:!0,lastName:!0,role:!0}}}});return"closed"===e.status&&await g.ticket.update({where:{id:s},data:{status:"open"}}),a.NextResponse.json(t)}catch(e){return console.error("Erreur lors de la cr\xe9ation du message:",e),a.NextResponse.json({id:`error-message-${Date.now()}`,content:o.content,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),userId:r,ticketId:s,user:{id:r,firstName:"Utilisateur",lastName:"Temporaire",role:"client"}})}}catch(e){return console.error("Erreur globale lors de la cr\xe9ation du message:",e),a.NextResponse.json({error:"Erreur serveur"},{status:500})}}let N=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/tickets/[id]/messages/route",pathname:"/api/tickets/[id]/messages",filename:"route",bundlePath:"app/api/tickets/[id]/messages/route"},resolvedPagePath:"C:\\Users\\audif\\Desktop\\appshade\\src\\app\\api\\tickets\\[id]\\messages\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:w,staticGenerationAsyncStorage:q,serverHooks:I}=N,j="/api/tickets/[id]/messages/route";function k(){return(0,i.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:q})}},49303:(e,t,r)=>{e.exports=r(30517)}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[2510,4140,2497],()=>r(87650));module.exports=s})();