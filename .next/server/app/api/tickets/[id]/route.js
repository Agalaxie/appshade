"use strict";(()=>{var e={};e.id=800,e.ids=[800],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},35816:e=>{e.exports=require("process")},6162:e=>{e.exports=require("worker_threads")},72254:e=>{e.exports=require("node:buffer")},6005:e=>{e.exports=require("node:crypto")},87561:e=>{e.exports=require("node:fs")},88849:e=>{e.exports=require("node:http")},22286:e=>{e.exports=require("node:https")},87503:e=>{e.exports=require("node:net")},49411:e=>{e.exports=require("node:path")},97742:e=>{e.exports=require("node:process")},84492:e=>{e.exports=require("node:stream")},72477:e=>{e.exports=require("node:stream/web")},41041:e=>{e.exports=require("node:url")},47261:e=>{e.exports=require("node:util")},65628:e=>{e.exports=require("node:zlib")},10810:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>$,patchFetch:()=>R,requestAsyncStorage:()=>w,routeModule:()=>N,serverHooks:()=>T,staticGenerationAsyncStorage:()=>D});var s={};r.r(s),r.d(s,{DELETE:()=>g,GET:()=>k,PATCH:()=>h});var o=r(49303),i=r(88716),n=r(60670),a=r(87070),u=r(12497),d=r(46986),c=r(53524),l=r(43895),p=r(92048),m=r.n(p),x=r(55315),E=r.n(x);let f=new c.PrismaClient({log:["error"]});async function k(e,{params:t}){if(console.log(`GET /api/tickets/${t.id} - D\xe9but`),t.id.startsWith("demo-")){console.log(`GET /api/tickets/${t.id} - Ticket de d\xe9monstration d\xe9tect\xe9`);let e={id:t.id,title:"Ticket de d\xe9monstration",description:"Ceci est un ticket de d\xe9monstration g\xe9n\xe9r\xe9 automatiquement.",priority:"medium",status:"in_progress",category:"support",userId:"demo",createdAt:new Date,updatedAt:new Date,clientName:"Client D\xe9mo",user:{id:"demo",email:"demo@example.com",firstName:"Utilisateur",lastName:"D\xe9mo"},messages:[{id:`msg-${Date.now()}-1`,content:"Bonjour, j'ai un probl\xe8me avec mon compte.",ticketId:t.id,senderId:"demo",senderType:"client",createdAt:new Date(Date.now()-36e5),read:!0,user:{id:"demo",email:"demo@example.com",firstName:"Utilisateur",lastName:"D\xe9mo"}},{id:`msg-${Date.now()}-2`,content:"Bonjour, je vais vous aider \xe0 r\xe9soudre ce probl\xe8me. Pouvez-vous me donner plus de d\xe9tails ?",ticketId:t.id,senderId:"admin",senderType:"admin",createdAt:new Date(Date.now()-18e5),read:!0,user:{id:"admin",email:"admin@example.com",firstName:"Admin",lastName:"Support"}}]};return a.NextResponse.json(e,{headers:{"Cache-Control":"no-store","X-Demo-Data":"true"}})}try{let e;try{if(!(e=(await (0,u.I)()).userId))return console.error("Utilisateur non authentifi\xe9"),a.NextResponse.json({error:"Non autoris\xe9"},{status:401})}catch(t){console.error("Erreur d'authentification:",t),e="demo-user",console.log("Utilisation de l'ID utilisateur de d\xe9mo:",e)}let{id:r}=t;if(r.startsWith("temp-")||r.startsWith("error-")||r.startsWith("demo-")){console.log("Ticket temporaire ou de d\xe9mo d\xe9tect\xe9:",r);let t=function(){try{let e=E().join(process.cwd(),"temp-tickets.json");if(m().existsSync(e)){let t=m().readFileSync(e,"utf8");return JSON.parse(t)}}catch(e){console.error("Erreur lors du chargement des tickets temporaires:",e)}return{}}(),s=null;if(Object.values(t).forEach(e=>{let t=e.find(e=>e.id===r);t&&(s=t)}),s)return console.log("Ticket temporaire trouv\xe9:",s.title),a.NextResponse.json(s);return a.NextResponse.json({id:r,title:r.startsWith("demo-")?"Hello world":"Ticket temporaire",description:r.startsWith("demo-")?"Ceci est un ticket de d\xe9monstration cr\xe9\xe9 pour tester l'application.":"Ce ticket est temporaire et n'a pas encore \xe9t\xe9 enregistr\xe9 dans la base de donn\xe9es.",status:"open",priority:"medium",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),userId:e,messages:[]})}try{let t=await f.ticket.findUnique({where:{id:r},include:{messages:{orderBy:{createdAt:"asc"},include:{user:{select:{id:!0,firstName:!0,lastName:!0,role:!0}}}},user:{select:{id:!0,firstName:!0,lastName:!0,email:!0,company:!0,phoneNumber:!0,address:!0,city:!0,postalCode:!0,country:!0,createdAt:!0,role:!0}}}});if(!t)return a.NextResponse.json({error:"Ticket non trouv\xe9"},{status:404});if(t.userId!==e){l.ZP.info(`V\xe9rification des permissions pour l'utilisateur ${e} sur le ticket ${r}`);let t=await (0,d.a)();l.ZP.info(`M\xe9tadonn\xe9es Clerk:`,t?.publicMetadata);let s=await f.user.findUnique({where:{id:e},select:{role:!0}});if(l.ZP.info(`R\xf4le dans la base de donn\xe9es:`,s?.role),s?.role!=="admin")return l.ZP.warn(`Acc\xe8s refus\xe9 pour l'utilisateur ${e} (r\xf4le: ${s?.role})`),a.NextResponse.json({error:"Non autoris\xe9"},{status:403});l.ZP.info(`Acc\xe8s autoris\xe9 pour l'administrateur ${e}`)}return a.NextResponse.json(t)}catch(t){return console.error("Erreur lors de la r\xe9cup\xe9ration du ticket:",t),a.NextResponse.json({id:r,title:"Ticket temporaire",description:"Impossible de r\xe9cup\xe9rer les d\xe9tails du ticket pour le moment.",status:"open",priority:"medium",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),userId:e,messages:[]})}}catch(e){return console.error("Erreur globale lors de la r\xe9cup\xe9ration du ticket:",e),a.NextResponse.json({error:"Erreur serveur"},{status:500})}}async function g(e,{params:t}){if(console.log(`DELETE /api/tickets/${t.id} - D\xe9but de la suppression`),!t.id||"string"!=typeof t.id||""===t.id.trim())return console.log(`DELETE /api/tickets/${t.id} - ID de ticket invalide`),a.NextResponse.json({error:"ID de ticket invalide"},{status:400});if(t.id.startsWith("demo-"))return console.log(`DELETE /api/tickets/${t.id} - Ticket de d\xe9monstration d\xe9tect\xe9, simulation de suppression`),a.NextResponse.json({success:!0,message:"Ticket de d\xe9monstration supprim\xe9 avec succ\xe8s"},{status:200});try{try{console.log(`DELETE /api/tickets/${t.id} - V\xe9rification de la connexion \xe0 la base de donn\xe9es`),await f.$queryRaw`SELECT 1`,console.log(`DELETE /api/tickets/${t.id} - Connexion \xe0 la base de donn\xe9es OK`)}catch(e){return console.error(`DELETE /api/tickets/${t.id} - Erreur de connexion \xe0 la base de donn\xe9es:`,e),a.NextResponse.json({error:"Erreur de connexion \xe0 la base de donn\xe9es"},{status:500})}let{userId:e}=(0,u.I)();if(console.log(`DELETE /api/tickets/${t.id} - Utilisateur authentifi\xe9: ${e}`),!e)return console.log(`DELETE /api/tickets/${t.id} - Utilisateur non authentifi\xe9`),a.NextResponse.json({error:"Non authentifi\xe9"},{status:401});let r=!1;try{console.log(`DELETE /api/tickets/${t.id} - V\xe9rification du r\xf4le de l'utilisateur`);let s=await f.user.findUnique({where:{id:e},select:{role:!0}});r=s?.role==="admin",console.log(`DELETE /api/tickets/${t.id} - Utilisateur est admin: ${r}`)}catch(e){console.error(`DELETE /api/tickets/${t.id} - Erreur lors de la v\xe9rification du r\xf4le:`,e),r=!1}console.log(`DELETE /api/tickets/${t.id} - R\xe9cup\xe9ration du ticket`);let s=await f.ticket.findUnique({where:{id:t.id},select:{userId:!0}});if(!s)return console.log(`DELETE /api/tickets/${t.id} - Ticket non trouv\xe9`),a.NextResponse.json({error:"Ticket non trouv\xe9"},{status:404});if(s.userId!==e&&!r)return console.log(`DELETE /api/tickets/${t.id} - Permission refus\xe9e`),a.NextResponse.json({error:"Permission refus\xe9e"},{status:403});return console.log(`DELETE /api/tickets/${t.id} - D\xe9but de la transaction de suppression`),await f.$transaction(async e=>{console.log(`DELETE /api/tickets/${t.id} - Suppression des r\xe9actions`),await e.messageReaction.deleteMany({where:{message:{ticketId:t.id}}}),console.log(`DELETE /api/tickets/${t.id} - Suppression des pi\xe8ces jointes`),await e.attachment.deleteMany({where:{ticketId:t.id}}),console.log(`DELETE /api/tickets/${t.id} - Suppression des messages`),await e.message.deleteMany({where:{ticketId:t.id}}),console.log(`DELETE /api/tickets/${t.id} - Suppression du ticket`),await e.ticket.delete({where:{id:t.id}})}),console.log(`DELETE /api/tickets/${t.id} - Suppression r\xe9ussie`),a.NextResponse.json({success:!0,message:"Ticket supprim\xe9 avec succ\xe8s"},{status:200})}catch(e){return console.error(`DELETE /api/tickets/${t.id} - Erreur lors de la suppression:`,e),a.NextResponse.json({error:"Erreur lors de la suppression du ticket",details:e instanceof Error?e.message:String(e)},{status:500})}}async function h(e,{params:t}){if(console.log(`PATCH /api/tickets/${t.id} - D\xe9but`),t.id.startsWith("demo-")){console.log(`PATCH /api/tickets/${t.id} - Ticket de d\xe9monstration d\xe9tect\xe9, simulation de mise \xe0 jour`);try{let r=await e.json();return console.log(`PATCH /api/tickets/${t.id} - Donn\xe9es re\xe7ues:`,r),a.NextResponse.json({success:!0,message:"Ticket de d\xe9monstration mis \xe0 jour avec succ\xe8s",data:{id:t.id,...r}},{status:200})}catch(e){return console.error(`PATCH /api/tickets/${t.id} - Erreur lors du parsing des donn\xe9es:`,e),a.NextResponse.json({error:"Donn\xe9es invalides"},{status:400})}}try{let r;try{if(!(r=(await (0,u.I)()).userId))return a.NextResponse.json({error:"Non autoris\xe9"},{status:401})}catch(e){console.error("Erreur d'authentification:",e),r="demo-user",console.log("Utilisation de l'ID utilisateur de d\xe9mo pour PATCH:",r)}let{id:s}=t,o=await e.json();if(s.startsWith("temp-")||s.startsWith("error-")||s.startsWith("demo-"))return a.NextResponse.json({...o,id:s,updatedAt:new Date().toISOString()});try{let e=await f.ticket.findUnique({where:{id:s}});if(!e)return a.NextResponse.json({error:"Ticket non trouv\xe9"},{status:404});if(e.userId!==r){let e=await f.user.findUnique({where:{id:r},select:{role:!0}});if(e?.role!=="admin")return a.NextResponse.json({error:"Non autoris\xe9"},{status:403})}let t=await f.ticket.update({where:{id:s},data:{status:o.status,updatedAt:new Date}});return a.NextResponse.json(t)}catch(e){return console.error("Erreur lors de la mise \xe0 jour du ticket:",e),a.NextResponse.json({error:"Erreur de base de donn\xe9es"},{status:500})}}catch(e){return console.error("Erreur globale lors de la mise \xe0 jour du ticket:",e),a.NextResponse.json({error:"Erreur serveur"},{status:500})}}let N=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/tickets/[id]/route",pathname:"/api/tickets/[id]",filename:"route",bundlePath:"app/api/tickets/[id]/route"},resolvedPagePath:"C:\\Users\\audif\\Desktop\\appshade\\src\\app\\api\\tickets\\[id]\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:w,staticGenerationAsyncStorage:D,serverHooks:T}=N,$="/api/tickets/[id]/route";function R(){return(0,n.patchFetch)({serverHooks:T,staticGenerationAsyncStorage:D})}},46986:(e,t,r)=>{r.d(t,{a:()=>i});var s=r(99744),o=r(12497);async function i(){let{userId:e}=(0,o.I)();return e?s.Ns.users.getUser(e):null}},99744:(e,t,r)=>{r.d(t,{Ns:()=>i});var s=r(52434),o=r(42089);let i=(0,s.gq)({apiKey:o.$h,secretKey:o.Cn,apiUrl:o.T5,apiVersion:o.Gn,userAgent:"@clerk/nextjs@4.30.0",proxyUrl:o.NM,domain:o.yK,isSatellite:o.lo})},49303:(e,t,r)=>{e.exports=r(30517)},43895:(e,t,r)=>{var s;r.d(t,{ZP:()=>d}),function(e){e[e.DEBUG=0]="DEBUG",e[e.INFO=1]="INFO",e[e.WARN=2]="WARN",e[e.ERROR=3]="ERROR",e[e.NONE=4]="NONE"}(s||(s={}));let o=3,i={},n=(e,t)=>`[${e}] ${t}`,a=e=>{let t=Date.now();if(!i[e])return i[e]={count:1,lastTime:t},!1;let r=i[e];return t-r.lastTime>1e4?(i[e]={count:1,lastTime:t},!1):(r.count++,10===r.count)?(r.lastTime=t,!1):1!==r.count},u={setLogLevel:e=>{o=e},getLogLevel:()=>o,debug:(e,...t)=>{if(o<=0){let r=`DEBUG:${e}`;if(!a(r)){let s=i[r];console.debug(n("DEBUG",e+(s&&s.count>1?` (r\xe9p\xe9t\xe9 ${s.count} fois)`:"")),...t)}}},info:(e,...t)=>{if(o<=1){let r=`INFO:${e}`;if(!a(r)){let s=i[r];console.info(n("INFO",e+(s&&s.count>1?` (r\xe9p\xe9t\xe9 ${s.count} fois)`:"")),...t)}}},warn:(e,...t)=>{if(o<=2){let r=`WARN:${e}`;if(!a(r)){let s=i[r];console.warn(n("WARN",e+(s&&s.count>1?` (r\xe9p\xe9t\xe9 ${s.count} fois)`:"")),...t)}}},error:(e,...t)=>{if(o<=3){let r=`ERROR:${e}`;if(!a(r)){let s=i[r];console.error(n("ERROR",e+(s&&s.count>1?` (r\xe9p\xe9t\xe9 ${s.count} fois)`:"")),...t)}}},once:(e,t,...r)=>{let s=`ONCE:${t}`;if(!i[s])switch(i[s]={count:1,lastTime:Date.now()},e){case 0:u.debug(t,...r);break;case 1:u.info(t,...r);break;case 2:u.warn(t,...r);break;case 3:u.error(t,...r)}}},d=u}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[2510,4140,2497],()=>r(10810));module.exports=s})();